<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <meta name="description" content="Cesium Demo">
    <title>Cesium Demo</title>

    <!-- Include Cesium via CDN -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.91/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.91/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #cesiumContainer {
            width: 100vw;
            height: 100vh;
        }
        #coordinateDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            z-index: 1;
        }
    </style>
</head>
<body>

<div id="cesiumContainer"></div>

<!-- Display for the coordinates -->
<div id="coordinateDisplay">
    <h3>Coordinates</h3>
    <label>Latitude: <span id="latitudeDisplay">-</span></label><br>
    <label>Longitude: <span id="longitudeDisplay">-</span></label><br>
    <label>Elevation: <span id="elevationDisplay">-</span></label><br>
    <label>Rotation (Heading): <span id="headingDisplay">0</span>Â°</label><br>

    <button id="rotateLeft">Rotate Left</button>
    <button id="rotateRight">Rotate Right</button><br><br>

    <button id="increaseElevation">Increase Elevation (+0.1 m)</button>
    <button id="decreaseElevation">Decrease Elevation (-0.1 m)</button><br><br>

    <button id="increaseLatitude">Increase Latitude (+0.1 m)</button>
    <button id="decreaseLatitude">Decrease Latitude (-0.1 m)</button><br><br>

    <button id="increaseLongitude">Increase Longitude (+0.1 m)</button>
    <button id="decreaseLongitude">Decrease Longitude (-0.1 m)</button>
</div>

<script>
    window.startup = function () {
        // Initialize the Cesium Viewer
        const viewer = new Cesium.Viewer("cesiumContainer", {
            timeline: false,
            animation: false,
            baseLayerPicker: false,
        });

        const scene = viewer.scene;
        scene.globe.depthTestAgainstTerrain = true;

        // Load the world terrain (correct function)
        let worldTerrain;
        try {
            worldTerrain = Cesium.createWorldTerrain();
            viewer.scene.terrainProvider = worldTerrain;
            scene.globe.show = false;
        } catch (error) {
            window.alert(`There was an error creating world terrain: ${error}`);
        }

        // Load the 3D Tileset
        let worldTileset;
        try {
            worldTileset = await Cesium.createGooglePhotorealistic3DTileset();
            viewer.scene.primitives.add(worldTileset);
        } catch (error) {
            console.log(`Error loading Photorealistic 3D Tiles tileset. ${error}`);
        }

        // Initial position and parameters for the model
        let latitude = 46.559079;
        let longitude = 15.643155;
        let elevation = 329.30; // Set elevation to 330 meters
        let heading = 8.00; // Initial rotation (heading) in degrees

        // Approximate meters-to-degrees conversion factors
        const meterToLatitudeDegree = 1 / 111320;
        function meterToLongitudeDegree(latitude) {
            return 1 / (111320 * Math.cos(Cesium.Math.toRadians(latitude)));
        }

        // Display coordinates in HTML
        function updateCoordinateDisplay() {
            document.getElementById('latitudeDisplay').innerText = latitude.toFixed(6);
            document.getElementById('longitudeDisplay').innerText = longitude.toFixed(6);
            document.getElementById('elevationDisplay').innerText = elevation.toFixed(2);
            document.getElementById('headingDisplay').innerText = heading.toFixed(2);
        }

        // Create the draggable model entity
        let modelEntity = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation),
            model: {
                uri: "https://raw.githubusercontent.com/zunuk/testni/7a41fd6e279312ace8d69043f38ae4d5cf422521/GPS_K_in_Vrata.glb",
                heightReference: Cesium.HeightReference.NONE,
                minimumPixelSize: 128,
                maximumScale: 0.97,
            },
            orientation: Cesium.Transforms.headingPitchRollQuaternion(
                Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation),
                new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading), 0, 0)
            ),
        });

        viewer.trackedEntity = modelEntity;

        // Set the default camera view to a much higher altitude for a wider view
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(longitude, latitude, 5000),
            orientation: {
                heading: 0.0,
                pitch: Cesium.Math.toRadians(-90.0), // Top-down view
                roll: 0.0,
            },
        });

        updateCoordinateDisplay();

        // ScreenSpaceEventHandler for dragging the model
        const handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
        let isDragging = false;
        let pickedEntity = null;

        const movementScale = 0.00001;

        handler.setInputAction((click) => {
            const pickedObject = scene.pick(click.position);
            if (Cesium.defined(pickedObject) && pickedObject.id === modelEntity) {
                isDragging = true;
                pickedEntity = pickedObject.id;
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

        handler.setInputAction((movement) => {
            if (isDragging && Cesium.defined(pickedEntity)) {
                const deltaLongitude = movement.endPosition.x - movement.startPosition.x;
                const deltaLatitude = movement.endPosition.y - movement.startPosition.y;

                longitude += deltaLongitude * movementScale;
                latitude -= deltaLatitude * movementScale;

                const newPosition = Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation);
                pickedEntity.position.setValue(newPosition);

                updateCoordinateDisplay();
            }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        handler.setInputAction(() => {
            isDragging = false;
            pickedEntity = null;
        }, Cesium.ScreenSpaceEventType.LEFT_UP);

        document.getElementById('rotateLeft').addEventListener('click', () => rotateModel(-1));
        document.getElementById('rotateRight').addEventListener('click', () => rotateModel(1));
        document.getElementById('increaseElevation').addEventListener('click', () => changeElevation(0.1));
        document.getElementById('decreaseElevation').addEventListener('click', () => changeElevation(-0.1));
        document.getElementById('increaseLatitude').addEventListener('click', () => changeLatitude(0.1));
        document.getElementById('decreaseLatitude').addEventListener('click', () => changeLatitude(-0.1));
        document.getElementById('increaseLongitude').addEventListener('click', () => changeLongitude(0.1));
        document.getElementById('decreaseLongitude').addEventListener('click', () => changeLongitude(-0.1));

        function rotateModel(degreeChange) {
            heading += degreeChange;
            const orientation = Cesium.Transforms.headingPitchRollQuaternion(
                Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation),
                new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading), 0, 0)
            );
            modelEntity.orientation = orientation;
            updateCoordinateDisplay();
        }

        function changeElevation(amount) {
            elevation += amount;
            const newPosition = Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation);
            modelEntity.position.setValue(newPosition);
            updateCoordinateDisplay();
        }

        function changeLatitude(amount) {
            latitude += amount * meterToLatitudeDegree;
            const newPosition = Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation);
            modelEntity.position.setValue(newPosition);
            updateCoordinateDisplay();
        }

        function changeLongitude(amount) {
            longitude += amount * meterToLongitudeDegree(latitude);
            const newPosition = Cesium.Cartesian3.fromDegrees(longitude, latitude, elevation);
            modelEntity.position.setValue(newPosition);
            updateCoordinateDisplay();
        }
    };

    window.startup().catch(error => console.error(error));
</script>
</body>
</html>
